import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InputMediaPhoto, InputMediaVideo
import yt_dlp
import os
import tempfile
import logging

TOKEN = "8258454286:AAG4B95JqKUNwmTDH9lcdBsoxkFf8AYC9qY"
bot = telebot.TeleBot(TOKEN)

# إعداد السجلات لمراقبة الأخطاء
logging.basicConfig(level=logging.INFO)

# تخزين حالة المستخدم
user_states = {}

def main_menu():
    """إنشاء لوحة المفاتيح الرئيسية"""
    markup = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add(
        KeyboardButton("Download from TikTok"),
        KeyboardButton("Download from Instagram"),
        KeyboardButton("Bot Info")
    )
    return markup

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(
        message.chat.id,
        "Welcome to the 2025 Downloader Bot!\nTikTok + Instagram (HD, No Watermark)",
        reply_markup=main_menu()
    )

@bot.message_handler(func=lambda m: True)
def handler(message):
    text = message.text
    user_id = message.from_user.id

    # التعامل مع الأزرار
    if text == "Download from TikTok":
        user_states[user_id] = "tiktok"
        bot.reply_to(message, "Send the TikTok link now.", reply_markup=main_menu())
        return

    if text == "Download from Instagram":
        user_states[user_id] = "instagram"
        bot.reply_to(message, "Send the Instagram link now.", reply_markup=main_menu())
        return

    if text == "Bot Info":
        bot.reply_to(
            message,
            "Downloader Bot 2025\nHD - No Watermark - Reels - Stories\nOwner: @Ziad",
            reply_markup=main_menu()
        )
        return

    # التعامل مع الروابط
    if user_id in user_states and text.startswith("http"):
        url = text.strip()
        status_msg = bot.reply_to(message, "Processing... please wait.")

        try:
            # إعدادات التحميل
            ydl_options = {
                "format": "best",
                "quiet": True,
                "no_warnings": True,
                # "cookiefile": "cookies.txt", # ملاحظة: انستجرام غالباً يحتاج ملف كوكيز
                "outtmpl": "%(id)s.%(ext)s" # سيتم تعديله داخل المجلد المؤقت
            }

            # استخدام مجلد مؤقت لضمان حذف الملفات بعد الإرسال
            with tempfile.TemporaryDirectory() as tmpdir:
                ydl_options["outtmpl"] = os.path.join(tmpdir, "%(id)s.%(ext)s")

                with yt_dlp.YoutubeDL(ydl_options) as ydl:
                    info = ydl.extract_info(url, download=True)
                    # الحصول على العنوان بشكل آمن
                    title = info.get("title", "Downloaded Media")
                    if title:
                        title = title[:70] # تقصير العنوان

                # جمع الملفات المحملة
                files = [
                    os.path.join(tmpdir, f)
                    for f in os.listdir(tmpdir)
                    if f.lower().endswith((".mp4", ".jpg", ".jpeg", ".png", ".webp"))
                ]
                
                # ترتيب الملفات لضمان الترتيب الصحيح
                files.sort()

                if not files:
                    raise Exception("No media found to download.")

                # إذا كان ملف واحد فقط
                if len(files) == 1:
                    file_path = files[0]
                    caption = f"{title}\n\n@tik_insta_z"
                    with open(file_path, "rb") as f:
                        if file_path.endswith(".mp4"):
                            bot.send_video(message.chat.id, f, caption=caption)
                        else:
                            bot.send_photo(message.chat.id, f, caption=caption)
                
                # إذا كانت مجموعة (ألبوم)
                else:
                    media_group = []
                    open_files = [] # للاحتفاظ بالملفات مفتوحة
                    
                    for index, file_path in enumerate(files):
                        caption = f"{title}\n\n@tik_insta_z" if index == 0 else None
                        f = open(file_path, "rb")
                        open_files.append(f)
                        
                        if file_path.endswith(".mp4"):
                            media_group.append(InputMediaVideo(f, caption=caption))
                        else:
                            media_group.append(InputMediaPhoto(f, caption=caption))

                    bot.send_media_group(message.chat.id, media_group)
                    
                    # إغلاق الملفات يدوياً بعد الإرسال
                    for f in open_files:
                        f.close()

            # حذف رسالة "جاري المعالجة" وإبلاغ المستخدم
            bot.delete_message(message.chat.id, status_msg.message_id)
            bot.send_message(message.chat.id, "Done! Choose another service:", reply_markup=main_menu())
            
            # إعادة تعيين الحالة
            user_states.pop(user_id, None)

        except Exception as e:
            logging.error(f"Error: {e}")
            bot.edit_message_text(
                f"Error downloading link.\nDetails: {str(e)[:100]}",
                message.chat.id,
                status_msg.message_id
            )
            user_states.pop(user_id, None)

    else:
        # إذا أرسل رابطاً دون اختيار الخدمة
        if text.startswith("http"):
            bot.reply_to(message, "Please choose 'Download from TikTok' or 'Instagram' first.", reply_markup=main_menu())
        else:
            bot.reply_to(message, "Please use the menu buttons.", reply_markup=main_menu())

print("Bot is running...")
bot.infinity_polling()
